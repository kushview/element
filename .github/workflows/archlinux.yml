name: Arch Linux Build

on:
  workflow_dispatch:

jobs:
  build-archlinux:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Build Arch Linux Docker image
      run: docker build -f Dockerfile.archlinux -t element:archlinux .
    
    - name: Build and test Element in Arch Linux container
      run: |
        docker run --rm --user $(id -u):$(id -g) -v $(pwd):/workspace element:archlinux bash -c "
          git config --global --add safe.directory /workspace && \
          git submodule update --init --recursive && \
          cmake -B build-arch -G Ninja -DCMAKE_BUILD_TYPE=Release -DELEMENT_BUILD_PLUGINS=ON -DELEMENT_BUILD_TESTS=ON && \
          cmake --build build-arch && \
          ctest --test-dir build-arch --output-on-failure
        "
